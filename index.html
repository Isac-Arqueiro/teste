<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Leitor Multiformato</title>
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #player { margin-top: 20px; }
    ul { list-style: none; padding: 0; }
    li { cursor: pointer; padding: 6px; border-bottom: 1px solid #ddd; }
    li:hover { background: #f0f0f0; }
    #busca { padding: 6px; width: 100%; margin: 10px 0; }
    #progresso { margin: 10px 0; font-weight: bold; }
    button { margin-right: 10px; padding: 6px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Minha Biblioteca</h2>

  <!-- OpÃ§Ã£o 1: Buscar URL -->
  <input type="text" id="urlInput" placeholder="Digite URL (.m3u, .m3u_plus ou .m3u8)">
  <button onclick="carregarURL()">Buscar</button>

  <!-- OpÃ§Ã£o 2: Lista interna -->
  <button onclick="carregarListaInterna()">Lista Interna</button>

  <div id="progresso"></div>

  <!-- Campo de pesquisa -->
  <input type="text" id="busca" placeholder="Pesquisar filme...">

  <!-- Lista de filmes -->
  <ul id="lista"></ul>

  <!-- Player -->
  <div id="player"></div>

<script>
// Lista interna de exemplo (canais ao vivo)
const listaInterna = `
#EXTM3U
#EXTINF:-1 tvg-logo="https://upload.wikimedia.org/wikipedia/commons/6/6c/TVGlobo.png", Globo
https://video-exemplo.com/globo.m3u8
#EXTINF:-1 tvg-logo="https://upload.wikimedia.org/wikipedia/commons/1/1b/SBT_logo.png", SBT
https://video-exemplo.com/sbt.m3u8
`;

// ---- IndexedDB ----
function abrirDB() {
  return new Promise((resolve, reject) => {
    let req = indexedDB.open("meuPlayerDB", 1);
    req.onupgradeneeded = e => {
      let db = e.target.result;
      if (!db.objectStoreNames.contains("conteudos")) {
        db.createObjectStore("conteudos", { keyPath: "id", autoIncrement: true });
      }
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e);
  });
}

async function salvarIndexedDB(itens) {
  let db = await abrirDB();
  let tx = db.transaction("conteudos", "readwrite");
  let store = tx.objectStore("conteudos");
  await new Promise(r => {
    let clear = store.clear();
    clear.onsuccess = () => r();
  });
  itens.forEach(item => store.add(item));
}

async function listarIndexedDB(filtro = "") {
  let db = await abrirDB();
  return new Promise(resolve => {
    let tx = db.transaction("conteudos", "readonly");
    let store = tx.objectStore("conteudos");
    let req = store.getAll();
    req.onsuccess = () => {
      let dados = req.result;
      if (filtro) {
        dados = dados.filter(c => c.nome.toLowerCase().includes(filtro.toLowerCase()));
      }
      resolve(dados);
    };
  });
}

// ---- Processa M3U (filmes/sÃ©ries) ----
function processarM3U(txt) {
  let linhas = txt.split("\n");
  let itens = [];
  let atual = {};
  let total = linhas.length;
  linhas.forEach((l, i) => {
    if (l.startsWith("#EXTINF")) {
      let nome = l.split(",")[1];
      let logo = "";
      let match = l.match(/tvg-logo="(.*?)"/);
      if (match) logo = match[1];
      atual = { nome, logo, tipo: "filme" };
    } else if (l.startsWith("http")) {
      atual.url = l.trim();
      itens.push(atual);
    }
    document.getElementById("progresso").textContent =
      "Processando: " + Math.round((i / total) * 100) + "%";
  });
  document.getElementById("progresso").textContent = "Finalizado!";
  return itens;
}

// ---- Carregar URL ----
async function carregarURL() {
  let url = document.getElementById("urlInput").value.trim();
  if (!url) {
    alert("Digite uma URL vÃ¡lida!");
    return;
  }

  // Se for canal ao vivo (.m3u8) â†’ abre direto
  if (url.endsWith(".m3u8")) {
    document.getElementById("progresso").textContent = "Abrindo canal ao vivo...";
    abrirPlayer(url);
    return;
  }

  // Caso contrÃ¡rio â†’ assume lista de filmes/sÃ©ries (.m3u ou .m3u_plus)
  document.getElementById("progresso").textContent = "Carregando lista de filmes...";
  try {
    let txt = await fetch(url).then(r => r.text());
    let itens = processarM3U(txt);
    await salvarIndexedDB(itens);
    mostrarLista(await listarIndexedDB());
  } catch (e) {
    document.getElementById("progresso").textContent = "Erro ao carregar lista!";
  }
}

// ---- Lista interna (canais) ----
async function carregarListaInterna() {
  document.getElementById("progresso").textContent = "Carregando lista interna (canais)...";
  let itens = processarM3U(listaInterna);
  // Aqui nÃ£o salva no DB â†’ canais nÃ£o ficam armazenados
  mostrarListaCanais(itens);
}

// ---- UI ----
function mostrarLista(itens) {
  let lista = document.getElementById("lista");
  lista.innerHTML = "";
  itens.forEach(item => {
    let li = document.createElement("li");
    li.innerHTML = (item.logo ? `<img src="${item.logo}" width="30" style="vertical-align:middle;margin-right:8px">` : "") +
                   "ðŸŽ¬ " + item.nome;
    li.onclick = () => abrirPlayer(item.url);
    lista.appendChild(li);
  });
}

function mostrarListaCanais(itens) {
  let lista = document.getElementById("lista");
  lista.innerHTML = "";
  itens.forEach(item => {
    let li = document.createElement("li");
    li.innerHTML = (item.logo ? `<img src="${item.logo}" width="30" style="vertical-align:middle;margin-right:8px">` : "") +
                   "ðŸ“º " + item.nome;
    li.onclick = () => abrirPlayer(item.url);
    lista.appendChild(li);
  });
}

function abrirPlayer(url) {
  document.getElementById("player").innerHTML = "";
  new Clappr.Player({
    source: url,
    parentId: "#player",
    width: "100%",
    height: 480
  });
}

// ---- Busca ----
document.getElementById("busca").addEventListener("input", async e => {
  let filtro = e.target.value;
  let dados = await listarIndexedDB(filtro);
  mostrarLista(dados);
});
</script>
</body>
</html>
