<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Leitor Multiformato</title>
  <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
</head>
<body>
  <h2>Minha Lista</h2>
  <input type="text" id="busca" placeholder="Pesquisar...">
  <ul id="lista"></ul>
  <div id="player"></div>

<script>
const urlM3U = "http://facilita.fun//get.php?username=TeamKakashi&password=4321123&type=m3u_plus&output=m3u8";

// salva no IndexedDB
function salvarIndexedDB(itens) {
  let req = indexedDB.open("meuPlayerDB", 1);
  req.onupgradeneeded = e => {
    let db = e.target.result;
    db.createObjectStore("canais", { keyPath: "id", autoIncrement: true });
  };
  req.onsuccess = e => {
    let db = e.target.result;
    let tx = db.transaction("canais", "readwrite");
    let store = tx.objectStore("canais");
    itens.forEach(item => store.add(item));
  };
}

async function carregarM3U() {
  let txt = await fetch(urlM3U).then(r => r.text());
  let linhas = txt.split("\n");
  let itens = [];
  let atual = {};
  linhas.forEach(l => {
    if (l.startsWith("#EXTINF")) {
      let nome = l.split(",")[1];
      atual = { nome };
    } else if (l.startsWith("http")) {
      atual.url = l.trim();
      itens.push(atual);
    }
  });
  salvarIndexedDB(itens);
  mostrarLista(itens);
}

function mostrarLista(itens) {
  let lista = document.getElementById("lista");
  lista.innerHTML = "";
  itens.forEach((item, i) => {
    let li = document.createElement("li");
    li.textContent = item.nome;
    li.onclick = () => abrirPlayer(item.url);
    lista.appendChild(li);
  });
}

function abrirPlayer(url) {
  document.getElementById("player").innerHTML = "";
  new Clappr.Player({
    source: url,
    parentId: "#player",
    width: "100%",
    height: 480
  });
}

carregarM3U();
</script>
</body>
</html>
